{{!--
 Creates a new Amazon Autoscaling Group.

  http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-as-group.html
 --}}
"asg{{this.Name}}":{
  "Type":"AWS::AutoScaling::AutoScalingGroup",
  "Properties":{
    "LaunchConfigurationName":{ "Ref":"aslc{{this.LaunchConfigurationName}}" },
    "VPCZoneIdentifier":[
    {{#each (lookupByNode @root.Region.SubnetIds this.SubnetId)}}
    "{{this}}"{{#unless @last}},{{/unless}}
    {{/each}}
    ],

{{!--
    {{~#if this.SubnetIndex}}
    {{~#if this.AssociatePublicIpAddress}}
    "VPCZoneIdentifier":["{{lookup @root.Region.SubnetIds.Public this.SubnetIndex}}"],
    {{~else}}
    "VPCZoneIdentifier":["{{lookup @root.Region.SubnetIds.Private this.SubnetIndex}}"],
    {{/if}}
    {{~else}}
    "VPCZoneIdentifier":{{#if this.AssociatePublicIpAddress~}}
      [ {{#each @root.Region.SubnetIds.Public}}"{{this}}"{{#unless @last}},{{/unless}}{{/each}} ],
    {{~else}}
      [ {{#each @root.Region.SubnetIds.Private}}"{{this}}"{{#unless @last}},{{/unless}}{{/each}} ],
    {{/if}}
    {{/if}}
 --}}

    {{#if this.LoadBalancerNames}}
    "LoadBalancerNames":[{{#each this.LoadBalancerNames}}{"Ref":"elb{{this}}"}{{#unless @last}},{{/unless}}{{/each}} ],
    {{/if}}
    "MinSize":{{default this.MinSize 0}},
    "MaxSize":{{default this.MaxSize 0}},
    "DesiredCapacity":{{default this.DesiredCapacity 0}},
    "HealthCheckGracePeriod":{{default this.HealthCheckGracePeriod 300}},

    "Tags":[
  {{#each @root.AutoscalingLaunchConfigurations}}
    {{#is this.Name ../LaunchConfigurationName}}
      {{#is this.AMI 'linux_amazon'}}{"PropagateAtLaunch":true,"Key":"Name","Value":"awla-{{@root.ProjectName}}-{{@root.EnvVersion}}{{@root.EnvName}}"},
      {{else startsWith 'linux_ubuntu' this.AMI}}{"PropagateAtLaunch":true,"Key":"Name","Value":"awlu-{{@root.ProjectName}}-{{@root.EnvVersion}}{{@root.EnvName}}"},
      {{else is this.AMI 'windows_core'}}{"PropagateAtLaunch":true,"Key":"Name","Value":"awwc-{{@root.ProjectName}}-{{@root.EnvVersion}}{{@root.EnvName}}"},
      {{else is this.AMI 'windows_base'}}{"PropagateAtLaunch":true,"Key":"Name","Value":"awwb-{{@root.ProjectName}}-{{@root.EnvVersion}}{{@root.EnvName}}"},
      {{/is~}}
    {{/is~}}
  {{/each}}
      {"PropagateAtLaunch":true,"Key":"Environment","Value":"{{@root.EnvName}}"},
      {"PropagateAtLaunch":true,"Key":"Version","Value":"{{@root.EnvVersion}}"},
      {"PropagateAtLaunch":true,"Key":"Project","Value":"{{@root.ProjectName}}"},
      {"PropagateAtLaunch":true,"Key":"Role","Value":"{{@root.ProjectName}}"},
      {"PropagateAtLaunch":true,"Key":"Owner","Value":"{{@root.Owner}}"}
    ]
  }
}
