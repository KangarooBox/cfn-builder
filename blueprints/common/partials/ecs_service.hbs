{{!--
  Creates an Amazon Elastic Container Service (Amazon ECS) service that runs and maintains the requested number of
  tasks and associated load balancers.

  http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-service.html
 --}}
"ecssrvc{{sanitize this.Name ''}}":{
  "Type": "AWS::ECS::Service",
  "Properties": {
    "Cluster":
      {{#startsWith "arn:aws:" this.Cluster}}
        "{{this.Cluster}}"
      {{else}}
        {"Fn::GetAtt":["ecsclst{{sanitize this.Cluster ''}}", "Arn"]}
      {{/startsWith}},
    {{#if this.DeploymentConfiguration}}"DeploymentConfiguration": DeploymentConfiguration,{{/if}}
    {{#if this.DeploymentController}}"DeploymentController": { {{{inject this.DeploymentController}}} },{{/if}}
    "DesiredCount": {{default this.DesiredCount 0}},
    {{#if this.LaunchType}}"LaunchType": "{{this.LaunchType}}",{{/if}}
    {{#if this.LoadBalancers}}"LoadBalancers": [ {{#each this.LoadBalancers}}{ {{{inject this}}} }{{comma}}{{/each}} ],{{/if}}
    {{#if this.NetworkConfiguration}}"NetworkConfiguration":
      {{#with this.NetworkConfiguration}}
      { "AwsvpcConfiguration": {
          {{#if this.AssignPublicIp}}"AssignPublicIp": "{{this.AssignPublicIp}}",{{/if}}
          {{#if this.SecurityGroups}}"SecurityGroups":[{{#each this.SecurityGroups}}{"Ref":"ec2sg{{this}}"}{{#unless @last}},{{/unless}}{{/each}}],{{/if}}
          "Subnets":[
            {{#each (lookupByNode @root.Region.Subnets this.SubnetId)}}
              {{#each this}}
                "{{this.Id}}"{{#unless @last}},{{/unless}}
              {{/each}}
            {{/each}}
          ]
        }
      {{/with}}
    },{{/if}}

    {{#if this.PlacementConstraints}}"PlacementConstraints": [ PlacementConstraints, ... ],{{/if}}
    {{#if this.Role}}"Role":{ "Fn::GetAtt":[ "iamr{{sanitize this.Role ''}}", "Arn"] },{{/if}}
    {{#if this.PlacementStrategies}}"PlacementStrategies": [ PlacementStrategies, ... ],{{/if}}
    {{#if this.PlatformVersion}}"PlatformVersion": "{{this.PlatformVersion}}",{{/if}}
    {{#if this.ServiceName}}"ServiceName": "{{this.ServiceName}}",{{/if}}
    "TaskDefinition": { "Ref":"ecstd{{sanitize this.TaskDefinition ''}}" }
  }
}
