"config":{
  "commands":{
    "aEnableCloudWatch":{
      "command":"$path='C:\\Program Files\\Amazon\\Ec2ConfigService\\Settings\\config.xml';$xml=[xml](Get-Content $path);$node=$xml.Ec2ConfigurationSettings.Plugins.Plugin | where {$_.Name -eq 'AWS.EC2.Windows.CloudWatch.PlugIn'};$node.State='Enabled';$xml.Save($path)"
    },
    "zRestartEc2Config":{
      "command":"Restart-Service AmazonSSMAgent"
    }
  },
  "files":{
    "C:\\Program Files\\Amazon\\Ec2ConfigService\\Settings\\AWS.EC2.Windows.CloudWatch.json":{
      "content":{
        "IsEnabled": true,
        "EngineConfiguration": {
          "PollInterval": "00:00:15",
          "Components": [
            { "FullName": "AWS.EC2.Windows.CloudWatch.EventLog.EventLogInputComponent,AWS.EC2.Windows.CloudWatch",
              "Id": "ApplicationEventLog", "Parameters": {"Levels": "1", "LogName": "Application"}
            },
            { "FullName": "AWS.EC2.Windows.CloudWatch.EventLog.EventLogInputComponent,AWS.EC2.Windows.CloudWatch",
              "Id": "SystemEventLog", "Parameters": {"Levels": "7", "LogName": "System"}
            },
            { "FullName": "AWS.EC2.Windows.CloudWatch.EventLog.EventLogInputComponent,AWS.EC2.Windows.CloudWatch",
              "Id": "SecurityEventLog", "Parameters": {"Levels": "7", "LogName": "Security"}
            },
            { "FullName": "AWS.EC2.Windows.CloudWatch.EventLog.EventLogInputComponent,AWS.EC2.Windows.CloudWatch",
              "Id": "ETW", "Parameters": {"Levels": "7", "LogName": "Microsoft-Windows-WinINet/Analytic"}
            },
            { "FullName": "AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch",
              "Id": "IISLogs",
              "Parameters": {
                "CultureName": "en-US",
                "Encoding": "UTF-8",
                "Filter": "",
                "LineCount": "3",
                "LogDirectoryPath": "C:\\inetpub\\logs\\LogFiles\\W3SVC1",
                "TimeZoneKind": "UTC",
                "TimestampFormat": "yyyy-MM-dd HH:mm:ss"
              }
            },
            { "FullName": "AWS.EC2.Windows.CloudWatch.PerformanceCounterComponent.PerformanceCounterInputComponent,AWS.EC2.Windows.CloudWatch",
                "Id": "PCMemory",
                "Parameters": {
                    "CategoryName": "Memory",
                    "CounterName": "Available MBytes",
                    "DimensionName": "InstanceId",
                    "DimensionValue": "{instance_id}",
                    "InstanceName": "",
                    "MetricName": "FreeMemory",
                    "Unit": "Megabytes"
                }
            },
            { "FullName": "AWS.EC2.Windows.CloudWatch.PerformanceCounterComponent.PerformanceCounterInputComponent,AWS.EC2.Windows.CloudWatch",
              "Id": "PCFreeDisk",
              "Parameters": {
                "CategoryName": "LogicalDisk",
                "CounterName": "Free Megabytes",
                "DimensionName": "InstanceId",
                "DimensionValue": "{instance_id}",
                "InstanceName": "C:",
                "MetricName": "FreeDisk",
                "Unit": "Megabytes"
              }
            },
            { "FullName": "AWS.EC2.Windows.CloudWatch.PerformanceCounterComponent.PerformanceCounterInputComponent,AWS.EC2.Windows.CloudWatch",
              "Id": "PCFreeDiskPct",
              "Parameters": {
                "CategoryName": "LogicalDisk",
                "CounterName": "% Free Space",
                "DimensionName": "InstanceId",
                "DimensionValue": "{instance_id}",
                "InstanceName": "C:",
                "MetricName": "FreeDiskPct",
                "Unit": "Percent"
              }
            },
            { "FullName": "AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch",
              "Id": "CloudWatchLogs",
              "Parameters": {
                "LogGroup": "{{@root.EnvVersion}}{{@root.EnvName}}",
                "LogStream": "{instance_id}_{{@root.ProjectName}}",
                "Region": "{{@root.Region.Id}}"
              }
            },
            { "FullName": "AWS.EC2.Windows.CloudWatch.CloudWatch.CloudWatchOutputComponent,AWS.EC2.Windows.CloudWatch",
              "Id": "CloudWatch",
              "Parameters": {
                "NameSpace": "Windows/Default",
                "Region": "{{@root.Region.Id}}"
              }
            }
          ],
          "Flows": {
            "Flows": [
              "(ApplicationEventLog,SystemEventLog),CloudWatchLogs",
              "(PCMemory, PCFreeDisk, PCFreeDiskPct),CloudWatch"
            ]
          }
        }
      }
    }
  }
}