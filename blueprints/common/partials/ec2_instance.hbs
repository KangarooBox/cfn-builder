{{!--
  Creates a new EC2 instance.

  http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-instance.html
 --}}
"ec2{{this.Name}}":{
  "Type":"AWS::EC2::Instance",
  "Properties":{
    {{#if this.Affinity}}"Affinity":"{{this.Affinity}}",{{/if}}
    {{#if this.SubnetIndex}}"AvailabilityZone":"{{this.AvailabilityZone}}",{{/if}}
    {{#if this.BlockDeviceMappings}}
    "BlockDeviceMappings":[{{#each this.BlockDeviceMappings}}{ {{{inject this}}} }{{#unless @last}},{{/unless}}{{/each}}],
    {{/if}}
    "DisableApiTermination":{{default (toString this.DisableApiTermination) false}},
    "EbsOptimized":{{default this.EbsOptimized false}},
    {{#if this.HostId}}"HostId":"{{this.HostId}}",{{/if}}
    {{#if this.IamInstanceProfile}}"IamInstanceProfile":{"Ref":"iamip{{this.IamInstanceProfile}}"},{{/if}}
    "ImageId":"{{findAMI this.ImageId @root.Region.AMIs}}",
    {{#if this.InstanceInitiatedShutdownBehavior}}"InstanceInitiatedShutdownBehavior":"{{this.InstanceInitiatedShutdownBehavior}}",{{/if}}
    "InstanceType":"{{this.InstanceType}}",
    {{#if this.KernelId}}"KernelId":"{{this.KernelId}}",{{/if}}
    {{#if this.KeyName}}"KeyName":"{{this.KeyName}}",{{/if}}
    "Monitoring":{{default this.InstanceMonitoring false}},
    {{#if this.NetworkInterfaces}}
    "NetworkInterfaces":[
      {{#each this.NetworkInterfaces}}{
        "Description":"{{this.Description}}",
        "AssociatePublicIpAddress":{{default this.AssociatePublicIpAddress false}},
        "SubnetId": {{#with (lookupByNode @root.Region.SubnetIds this.SubnetId) }}"{{this.[0]}}"{{/with}},
        {{!-- "DeleteOnTermination":{{#if this.DeleteOnTermination}}true{{else}}false{{/if}}, --}}
        "DeviceIndex":"{{default this.DeviceIndex 0}}",
        "GroupSet":[{{#each this.GroupSet}}{"Ref":"ec2sg{{this}}"}{{#unless @last}},{{/unless}}{{/each}}]
      }{{#unless @last}},{{/unless}}{{/each}}],
    {{/if}}

    {{#if this.PlacementGroupName}}"PlacementGroupName":"{{this.PlacementGroupName}}",{{/if}}
    {{#if this.PrivateIpAddress}}"PrivateIpAddress":"{{this.PrivateIpAddress}}",{{/if}}
    {{#if this.RamdiskId}}"RamdiskId":"{{this.RamdiskId}}",{{/if}}
    {{#if this.SecurityGroups}}"SecurityGroupIds":[{{#each this.SecurityGroups}}{"Ref":"ec2sg{{this}}"}{{#unless @last}},{{/unless}}{{/each}}],{{/if}}
    {{#if this.SsmAssociations}}"SsmAssociations":[{{#each this.SsmAssociations}}{"Ref":"ssmd{{this}}"}{{#unless @last}},{{/unless}}{{/each}}]{{/if}}

    "SourceDestCheck":{{default (toString this.SourceDestCheck) true}},
    {{#if this.SubnetId}}"SubnetId": {{#with (lookupByNode @root.Region.SubnetIds this.SubnetId) }}"{{this.[0]}}"{{/with}},{{/if}}

    {{#if this.Tenancy}}"Tenancy":"{{this.Tenancy}}",{{/if}}
    {{#if this.UserData}}"UserData":{ {{{inject this.UserData}}} },{{/if}}
    {{!-- "Volumes":[ EC2 MountPoint, ... ], --}}
    {{#if this.AdditionalInfo}}"AdditionalInfo":"{{this.AdditionalInfo}}",{{/if}}

    "Tags":[
      {{#startsWith 'linux_ubuntu' this.ImageId}}
      { "Key":"Name",         "Value":"awlu-{{@root.ProjectName}}-{{@root.EnvVersion}}{{@root.EnvName}}" },
      {{else is this.ImageId 'linux_amazon'}}
      { "Key":"Name",         "Value":"awla-{{@root.ProjectName}}-{{@root.EnvVersion}}{{@root.EnvName}}" },
      {{else is this.ImageId 'windows_core'}}
      { "Key":"Name",         "Value":"awwc-{{@root.ProjectName}}-{{@root.EnvVersion}}{{@root.EnvName}}" },
      {{else is this.ImageId 'windows_base'}}
      { "Key":"Name",         "Value":"awwb-{{@root.ProjectName}}-{{@root.EnvVersion}}{{@root.EnvName}}" },
      {{else}}
      { "Key":"Name",         "Value":"awunk-{{@root.ProjectName}}-{{@root.EnvVersion}}{{@root.EnvName}}" },
      {{/startsWith}}
      { "Key":"Environment",  "Value":"{{@root.EnvName}}" },
      { "Key":"Version",      "Value":"{{@root.EnvVersion}}" },
      { "Key":"Project",      "Value":"{{@root.ProjectName}}" },
      { "Key":"Role",         "Value":"{{@root.ProjectName}}" },
      { "Key":"Owner",        "Value":"{{@root.Owner}}" }
    ]
  }
}
