{{!--
  Creates a new Amazon ElasticLoadBalancer.

  http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-loadbalancer.html
  http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-listener.html
  http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-listenerrule.html
 --}}
"elbv2{{sanitize this.Name ''}}": {
  "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
  "Properties": {
    "Name": "{{this.Name}}-{{@root.EnvName}}",
    "Scheme": "{{this.Scheme}}",
    "Subnets":[
      {{#each (lookupByNode @root.Region.SubnetIds this.SubnetId)}}
      "{{this}}"{{#unless @last}},{{/unless}}
      {{/each}}
    ],
    {{#if this.LoadBalancerAttributes}}
    "LoadBalancerAttributes": [
      {{#each this.LoadBalancerAttributes}}
      { "Key": "{{this.Key}}", "Value": "{{this.Value}}"}
      {{#unless @last}},{{/unless}}{{/each}}
    ],
    {{/if}}
    {{#if this.SecurityGroups}}
    "SecurityGroups":[{{#each this.SecurityGroups}}{"Ref":"ec2sg{{this}}"}{{#unless @last}},{{/unless}}{{/each}}],
    {{/if}}
    {{#if this.Type}}"Type": "{{this.Type}}",{{/if}}
    {{> tags}}
  }
},

{{#each this.Listeners}}
"elbv2lis{{sanitize ../Name ''}}{{this.Port}}": {
  "Type": "AWS::ElasticLoadBalancingV2::Listener",
  "Properties": {
    {{#if this.Certificates}}"Certificates": [{{#each this.Certificates}}{"CertificateArn":"{{this}}"}{{#unless @last}},{{/unless}}{{/each}}],{{/if}}
    {{#if this.SslPolicy}}"SslPolicy": "{{this.SslPolicy}}",{{/if}}
    "DefaultActions": [
      {{#each this.DefaultActions}}
      {{#if this.RedirectConfig}}
        { "Type":"{{this.Type}}", "RedirectConfig":{ {{{inject this.RedirectConfig}}} }}
      {{else}}
        { "TargetGroupArn": {"Ref":"elbv2tg{{sanitize this.TargetGroupArn ''}}"}, "Type":"{{this.Type}}"}
      {{/if}}
      {{#unless @last}},{{/unless}}{{/each}}
    ],
    "LoadBalancerArn": { "Ref": "elbv2{{sanitize ../Name ''}}" },
    "Port": "{{this.Port}}",
    "Protocol": "{{uppercase this.Protocol}}"
  }
}

  {{#each this.Rules}}
  ,"elbv2lisrul{{sanitize ../../Name ''}}{{../this.Port}}{{@index}}": {
    "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
    "Properties": {
      "Actions": [ {{#each this.Actions}}{ "TargetGroupArn": {"Ref":"elbv2tg{{sanitize this.TargetGroupArn ''}}"}, "Type":"{{this.Type}}"}{{#unless @last}},{{/unless}}{{/each}}],
      "Conditions": [
      {{#each this.Conditions}}{ "Field": "{{this.Field}}", "Values":[
        {{#each this.Values}}"{{this}}"{{#unless @last}},{{/unless}}{{/each}}
        ]}{{#unless @last}},{{/unless}}{{/each}}
      ],
      "ListenerArn": {"Ref": "elbv2lis{{sanitize ../../Name ''}}{{../this.Port}}" },
      "Priority": {{this.Priority}}
    }
  }{{/each}}
{{#unless @last}},{{/unless}}{{/each}}
